# Segment-Specific Topics & Questions - Implementation Complete

**Date:** 2025-10-16  
**Deployment URL:** https://vh140tucenld.space.minimax.io

## Overview

Successfully implemented a complete separation between the main broadcast question display and the BetaBot AI question system. The main display now shows topic and question content that is **tied directly to the active show segment**, while BetaBot questions remain exclusive to the chat-style popup overlay.

---

## What Changed

### Phase 1: Database Schema ✅
Added two new columns to the `show_segments` table:
- `segment_topic` (TEXT, nullable) - A short topic/theme for the segment
- `segment_question` (TEXT, nullable) - The main discussion question for the segment

### Phase 2: TypeScript Types ✅
Updated the `ShowSegment` interface in `src/lib/supabase.ts`:
```typescript
export interface ShowSegment {
  id: string
  segment_name: string
  segment_topic: string | null        // NEW
  segment_question: string | null     // NEW
  is_active: boolean
  timer_seconds: number
  timer_running: boolean
  segment_order: number
  created_at: string
  updated_at: string
}
```

### Phase 3: Operator Dashboard UI ✅
Enhanced `SegmentControlPanel.tsx` with:

**New UI Elements:**
- "Topic" input field for the active segment
- "Question" textarea for the active segment
- Real-time save indicator
- Segment buttons now display the topic (if set)

**Auto-Save Logic:**
- Debounced saving (500ms delay after typing stops)
- No manual save button required
- Visual feedback when saving

**Code Implementation:**
```typescript
const saveSegmentContent = useCallback(async (segmentId: string, topic: string, question: string) => {
  setIsSaving(true);
  await supabase
    .from('show_segments')
    .update({ 
      segment_topic: topic || null, 
      segment_question: question || null 
    })
    .eq('id', segmentId);
  setTimeout(() => setIsSaving(false), 300);
}, []);
```

### Phase 4: Broadcast Overlay Display ✅
Completely refactored `BroadcastOverlayView.tsx`:

**Removed:**
- `playingQuestion` state (was from `show_questions` table)
- `loadPlayingQuestion()` function
- Subscription to `show_questions` table for main display
- Auto-play logic for question audio

**Added:**
- Main question display now reads from `activeSegment.segment_topic` and `activeSegment.segment_question`
- Premium styling for the segment topic (yellow, uppercase, 20px)
- Conditional rendering (only shows if topic OR question is set)

**Updated JSX:**
```tsx
{activeSegment && (activeSegment.segment_topic || activeSegment.segment_question) && !isAudioPlaying && (
  <div className="question-display">
    <div className="question-content">
      {activeSegment.segment_topic && (
        <p className="segment-topic">{activeSegment.segment_topic}</p>
      )}
      {activeSegment.segment_question && (
        <p className="question-text">{activeSegment.segment_question}</p>
      )}
    </div>
  </div>
)}
```

**Preserved:**
- All BetaBot popup functionality remains intact
- BetaBot popup still uses the `show_questions` table
- Timeline, Next Up, and all other premium features unchanged

---

## How It Works Now

### Two Independent Question Systems

#### 1. Main Segment Questions (NEW)
**Purpose:** Show the core topic/question for the current segment of the show  
**Source:** `show_segments` table (`segment_topic`, `segment_question`)  
**Display:** Bottom of screen, large premium typography  
**Control:** Edited in "Segment Control" panel by the operator  
**Behavior:**
- Automatically updates when a new segment becomes active
- Auto-hides when TTS audio is playing
- Persists with the segment (saved to database)

#### 2. BetaBot AI Questions (EXISTING)
**Purpose:** AI-generated follow-up questions, fun prompts, audience engagement  
**Source:** `show_questions` table (generated by Edge Functions)  
**Display:** Chat-style popup in top-right corner  
**Control:** Triggered by "Send to overlay" button in "Show Prep" panel  
**Behavior:**
- Appears as a popup overlay
- Has Play, Next, and Dismiss buttons
- Can cycle through multiple questions
- Independent of segment state

---

## Operator Workflow

### Setting Up Segment Questions

1. **Navigate to "Segment Control" Panel** (on operator dashboard)
2. **Click on the segment** you want to edit (activates it)
3. **Fill in the fields:**
   - **Topic:** Short, punchy theme (e.g., "AI Safety")
   - **Question:** Full discussion question (e.g., "Should AI development be regulated by governments?")
4. **Auto-save happens** 500ms after you stop typing
5. **Live update** - The broadcast overlay immediately reflects changes

### Using BetaBot Questions

1. **Audio Capture** (optional): Enable audio capture to generate questions from stream
2. **Show Prep Panel**: Questions appear in the queue (auto-generated or manual)
3. **Send to Overlay**: Click the button to trigger the BetaBot popup on broadcast
4. **Popup appears** on the broadcast overlay with Play/Next/Dismiss controls

---

## Visual Design

### Main Question Display
- **Position:** Bottom of screen
- **Background:** Black gradient with 2px yellow top border
- **Topic:** 20px, bold, uppercase, yellow (`#FBBF24`)
- **Question:** 36px, semi-bold, white, generous line height
- **Auto-hide:** Fades out when TTS audio is playing

### BetaBot Popup
- **Position:** Top-right corner
- **Style:** Chat-style card with red/yellow accents
- **Controls:** Three buttons (Play, Next, Dismiss)
- **Independent:** Works alongside main questions without conflict

---

## Technical Details

### Database Changes
```sql
ALTER TABLE show_segments 
ADD COLUMN segment_topic TEXT,
ADD COLUMN segment_question TEXT;
```

### Files Modified
1. **Database:** `show_segments` table (migration applied)
2. **Types:** `src/lib/supabase.ts` - Updated `ShowSegment` interface
3. **Operator UI:** `src/components/SegmentControlPanel.tsx` - New edit fields + auto-save
4. **Broadcast UI:** `src/components/BroadcastOverlayView.tsx` - New display logic

### Real-time Sync
- Supabase Realtime subscriptions ensure instant updates
- Operator edits → Database → Broadcast overlay (< 500ms latency)
- No page refresh required

---

## Testing Checklist

### Operator Dashboard (`/`)
- [ ] Click on a segment in "Segment Control"
- [ ] Type a topic (e.g., "Technology")
- [ ] Type a question (e.g., "What's the future of AI?")
- [ ] Verify "Saving..." indicator appears
- [ ] Verify segment button shows the topic
- [ ] Switch to another segment
- [ ] Verify fields update to that segment's content

### Broadcast Overlay (`/broadcast`)
- [ ] Activate a segment with topic + question
- [ ] Verify main display shows both
- [ ] Activate a segment with only a question
- [ ] Verify only question displays (no topic)
- [ ] Play TTS audio (BetaBot or otherwise)
- [ ] Verify main display auto-hides
- [ ] Stop audio
- [ ] Verify main display returns
- [ ] Send a BetaBot question to overlay
- [ ] Verify popup appears independently
- [ ] Verify both systems work simultaneously

---

## Benefits

✅ **Clear Separation of Concerns:** Segment questions are for planned content, BetaBot is for dynamic AI engagement  
✅ **Operator Control:** Direct, real-time editing of segment questions without code  
✅ **Professional Workflow:** Auto-save, visual feedback, intuitive UI  
✅ **No Conflicts:** Both systems can coexist without interfering  
✅ **Backward Compatible:** All existing BetaBot functionality preserved  

---

## Next Steps (Optional)

### Potential Enhancements
1. **Rich Text Editor:** Support for bold, italics, bullet points in questions
2. **Topic Icons:** Visual icons/emojis for segment topics
3. **Question Bank:** Pre-saved question templates for quick reuse
4. **Multi-language:** Support for questions in different languages
5. **Question History:** Archive and reuse questions from previous shows

---

## Support

For issues or questions:
1. Check the TypeScript types in `src/lib/supabase.ts`
2. Review component logic in `SegmentControlPanel.tsx` and `BroadcastOverlayView.tsx`
3. Verify database schema in Supabase dashboard
4. Check browser console for real-time subscription errors

---

**Implementation Status:** ✅ Complete  
**Build Status:** ✅ Successful  
**Deployment Status:** ✅ Live at https://vh140tucenld.space.minimax.io  
**Author:** MiniMax Agent
