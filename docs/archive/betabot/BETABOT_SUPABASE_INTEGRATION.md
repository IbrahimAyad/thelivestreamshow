# âœ… BetaBot + Producer AI Integration - Supabase Version

## ğŸ¯ What Changed

Updated `useBetaBotComplete` to work with your existing Producer AI system using **Supabase real-time subscriptions** instead of WebSocket.

---

## ğŸ”§ Changes Made

### File: `src/hooks/useBetaBotComplete.ts`

**Before:**
```typescript
// Used WebSocket connection
const ws = new WebSocket('ws://localhost:8080/transcript');
ws.onmessage = (event) => {
  // Process transcript or question
};
```

**After:**
```typescript
// Uses Supabase real-time subscriptions
const transcriptChannel = supabase
  .channel('betabot_transcripts')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'betabot_conversation_log'
  }, (payload) => {
    // Process new transcript
    handleTranscriptUpdate(payload.new.transcript_text);
  })
  .subscribe();

const questionsChannel = supabase
  .channel('producer_questions')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'show_questions'
  }, (payload) => {
    // Process Producer AI question
    if (payload.new.source === 'producer_ai') {
      speakProducerQuestion(payload.new);
    }
  })
  .subscribe();
```

---

## ğŸ“Š How It Works Now

### Data Flow

```
Stream Audio
    â†“
[Producer AI] (useProducerAI.ts)
    â†“
Analyzes transcripts every 2 minutes
    â†“
Stores in Supabase:
  - betabot_conversation_log (transcripts)
  - show_questions (generated questions)
    â†“
[Supabase Real-time] triggers subscriptions
    â†“
[BetaBot] (useBetaBotComplete.ts)
    â†“
â”œâ”€ New transcript â†’ Check for "Hey BetaBot" keyword
â””â”€ New question â†’ Speak immediately (TTS)
```

---

## ğŸ¬ Two Input Modes

### Mode 1: Keyword Activation (User says on stream)

```
User: "Hey BetaBot Alakazam when did World War 2 start?"
    â†“
Transcript stored in betabot_conversation_log
    â†“
BetaBot receives via Supabase subscription
    â†“
detectKeywords() â†’ Wake word âœ… + Alakazam âœ…
    â†“
Searches Perplexity
    â†“
Speaks result + displays on stream
```

### Mode 2: Producer AI Questions (Automatically generated)

```
Producer AI analyzes conversation
    â†“
Generates question: "That's fascinating! How did you..."
    â†“
Stores in show_questions table (source: 'producer_ai')
    â†“
BetaBot receives via Supabase subscription
    â†“
Speaks immediately (TTS)
    â†“
Displays as super chat
```

---

## ğŸ—„ï¸ Database Tables Used

### `betabot_conversation_log`
Stores all transcripts from the stream.

**Columns BetaBot uses:**
- `id` - Unique identifier (for deduplication)
- `transcript_text` - The actual transcript
- `created_at` - Timestamp
- `speaker_type` - Who spoke (host, guest, etc.)

**BetaBot listens for:** `INSERT` events

### `show_questions`
Stores questions generated by Producer AI.

**Columns BetaBot uses:**
- `id` - Unique identifier (for deduplication)
- `question_text` - The question to speak
- `source` - Where it came from ('producer_ai', 'manual', etc.)
- `ai_generated` - Boolean flag
- `context_summary` - Mode/context info
- `created_at` - Timestamp

**BetaBot listens for:** `INSERT` events where `source = 'producer_ai'`

---

## ğŸ¯ Subscription Logic

### Transcript Subscription
```typescript
// Subscribe to new transcripts
const transcriptChannel = supabase
  .channel('betabot_transcripts')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'betabot_conversation_log'
  }, (payload) => {
    const newTranscript = payload.new;

    // Avoid duplicate processing
    if (lastTranscriptIdRef.current === newTranscript.id) return;
    lastTranscriptIdRef.current = newTranscript.id;

    // Update live transcript
    setLiveTranscript(newTranscript.transcript_text);

    // Check for keywords
    handleTranscriptUpdate(newTranscript.transcript_text);
  })
  .subscribe();
```

### Producer AI Question Subscription
```typescript
// Subscribe to Producer AI questions
const questionsChannel = supabase
  .channel('producer_questions')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'show_questions'
  }, (payload) => {
    const newQuestion = payload.new;

    // Avoid duplicate processing
    if (lastQuestionIdRef.current === newQuestion.id) return;
    lastQuestionIdRef.current = newQuestion.id;

    // Only process Producer AI questions
    if (newQuestion.source === 'producer_ai' || newQuestion.ai_generated) {
      speakProducerQuestion({
        question: newQuestion.question_text,
        mode: newQuestion.context_summary || 'creative',
        context: newQuestion
      });
    }
  })
  .subscribe();
```

---

## ğŸš€ Benefits

### âœ… No Backend Changes Needed
- Producer AI already works with Supabase
- No WebSocket server to set up
- No new infrastructure

### âœ… Real-time Performance
- Supabase real-time is fast (~100-200ms latency)
- Comparable to WebSocket performance
- Built-in reconnection handling

### âœ… Reliability
- Automatic reconnection
- Message deduplication (via ID tracking)
- No message loss (database-backed)

### âœ… Scalability
- Supabase handles connection pooling
- Can support multiple BetaBot instances
- Database persistence for debugging

---

## ğŸ” Deduplication Strategy

BetaBot tracks the last processed IDs to avoid duplicate processing:

```typescript
const lastTranscriptIdRef = useRef<string | null>(null);
const lastQuestionIdRef = useRef<string | null>(null);

// In subscription handler:
if (lastTranscriptIdRef.current === newTranscript.id) {
  return; // Already processed
}
lastTranscriptIdRef.current = newTranscript.id;
```

**Why this matters:**
- Supabase subscriptions can sometimes fire multiple times
- Prevents BetaBot from processing same transcript twice
- Prevents speaking the same question multiple times

---

## ğŸ“ Environment Variables

No new environment variables needed! BetaBot uses existing Supabase config:

```bash
# Already in your .env.local
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key

# Search API keys (if you have them)
VITE_PERPLEXITY_API_KEY=your-perplexity-key
VITE_YOUTUBE_API_KEY=your-youtube-key
VITE_UNSPLASH_ACCESS_KEY=your-unsplash-key
```

---

## ğŸ§ª Testing the Integration

### Test 1: Keyword Activation

**Steps:**
1. Add a transcript to `betabot_conversation_log`:
```sql
INSERT INTO betabot_conversation_log (transcript_text, speaker_type)
VALUES ('Hey BetaBot Alakazam when did World War 2 start', 'user');
```

2. Watch console:
```
ğŸ“¨ New transcript: Hey BetaBot Alakazam when did World War 2 start
ğŸ‘‹ Wake word detected!
ğŸ¯ Action: alakazam
ğŸ’¬ Query: "when did World War 2 start"
ğŸ” Alakazam! Searching Perplexity...
ğŸ”Š Speaking: [Perplexity result]
```

3. âœ… Expected: BetaBot searches Perplexity and speaks result

---

### Test 2: Producer AI Question

**Steps:**
1. Let Producer AI generate a question (or insert manually):
```sql
INSERT INTO show_questions (
  question_text,
  source,
  ai_generated,
  context_summary
)
VALUES (
  'That's fascinating! Can you tell us more?',
  'producer_ai',
  true,
  'creative'
);
```

2. Watch console:
```
ğŸ“¨ Producer AI question: That's fascinating! Can you tell us more?
ğŸ”Š Speaking now...
âœ… Finished speaking
```

3. âœ… Expected: BetaBot speaks the question immediately

---

### Test 3: Normal Conversation (No Wake Word)

**Steps:**
1. Add transcript WITHOUT wake word:
```sql
INSERT INTO betabot_conversation_log (transcript_text, speaker_type)
VALUES ('I think that's a really interesting point', 'user');
```

2. Watch console:
```
ğŸ“¨ New transcript: I think that's a really interesting point
```

3. âœ… Expected: BetaBot does NOTHING (no wake word detected)

---

## ğŸ› ï¸ Troubleshooting

### BetaBot not receiving transcripts

**Check:**
1. Supabase real-time is enabled for the table
2. Console shows: `âœ… Subscribed to transcripts`
3. RLS policies allow reading `betabot_conversation_log`

**Fix:**
```sql
-- Enable real-time
ALTER PUBLICATION supabase_realtime ADD TABLE betabot_conversation_log;

-- Check RLS policy
SELECT * FROM pg_policies WHERE tablename = 'betabot_conversation_log';
```

---

### BetaBot not receiving Producer AI questions

**Check:**
1. Supabase real-time is enabled for the table
2. Console shows: `âœ… Subscribed to Producer AI questions`
3. Questions have `source = 'producer_ai'` or `ai_generated = true`

**Fix:**
```sql
-- Enable real-time
ALTER PUBLICATION supabase_realtime ADD TABLE show_questions;

-- Verify question source
SELECT id, question_text, source, ai_generated
FROM show_questions
ORDER BY created_at DESC
LIMIT 5;
```

---

### Duplicate processing

**Check:**
- Console logs show same transcript ID multiple times
- Same question being spoken twice

**Fix:**
- Already handled via `lastTranscriptIdRef` and `lastQuestionIdRef`
- If still happening, check for multiple `useBetaBotComplete` instances

---

## ğŸ“Š Performance Comparison

### Supabase Real-time vs WebSocket

| Metric | Supabase | WebSocket |
|--------|----------|-----------|
| **Latency** | 100-200ms | 50-100ms |
| **Setup** | âœ… None (built-in) | âš ï¸ Server required |
| **Reconnection** | âœ… Automatic | âš ï¸ Manual |
| **Message Loss** | âœ… None (DB-backed) | âš ï¸ Possible |
| **Debugging** | âœ… Easy (check DB) | âš ï¸ Harder |
| **Scalability** | âœ… Excellent | âš ï¸ Manual |

**Verdict:** Supabase real-time is the right choice for this use case.

---

## ğŸ¯ Integration Complete

### âœ… What Works Now

1. **Keyword Activation**
   - User says "Hey BetaBot Alakazam ..."
   - Transcript stored in DB â†’ BetaBot receives â†’ Searches â†’ Speaks

2. **Producer AI Questions**
   - Producer AI generates question
   - Stored in DB â†’ BetaBot receives â†’ Speaks immediately

3. **No Accidental Searches**
   - Multi-model fusion fixed (Perplexity removed)
   - Only searches with explicit keywords

4. **Fast Responses**
   - BetaBot receives transcripts in real-time
   - ~100-200ms latency for subscriptions

---

## ğŸ“š Files Modified

1. **`src/hooks/useBetaBotComplete.ts`**
   - Replaced WebSocket with Supabase subscriptions
   - Added import for `supabase`
   - Added deduplication refs (`lastTranscriptIdRef`, `lastQuestionIdRef`)

---

## ğŸš€ Next Steps

1. **Verify API Keys**
   - Check `.env.local` for Perplexity, YouTube, Unsplash keys
   - Producer AI should already have these if you've used search before

2. **Test Keyword Activation**
   - Insert test transcripts with wake word
   - Verify BetaBot detects keywords correctly

3. **Test Producer AI Integration**
   - Let Producer AI run and generate questions
   - Verify BetaBot speaks them automatically

4. **Monitor Performance**
   - Check console logs for subscription status
   - Verify no duplicate processing
   - Monitor response times

---

## ğŸ“ Summary

**What we accomplished:**
- âœ… Integrated BetaBot with existing Producer AI system
- âœ… No backend changes needed (uses Supabase)
- âœ… Real-time transcripts and questions
- âœ… Keyword-based search activation
- âœ… Producer AI question speaking
- âœ… No accidental searches (multi-model fusion fixed)

**Architecture:**
- Producer AI: Analyzes transcripts, generates questions â†’ Supabase
- BetaBot: Subscribes to Supabase â†’ Responds to keywords â†’ Speaks

**Ready to test!** ğŸ‰
