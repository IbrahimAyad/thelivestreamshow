# ✅ BetaBot + Producer AI Integration - Supabase Version

## 🎯 What Changed

Updated `useBetaBotComplete` to work with your existing Producer AI system using **Supabase real-time subscriptions** instead of WebSocket.

---

## 🔧 Changes Made

### File: `src/hooks/useBetaBotComplete.ts`

**Before:**
```typescript
// Used WebSocket connection
const ws = new WebSocket('ws://localhost:8080/transcript');
ws.onmessage = (event) => {
  // Process transcript or question
};
```

**After:**
```typescript
// Uses Supabase real-time subscriptions
const transcriptChannel = supabase
  .channel('betabot_transcripts')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'betabot_conversation_log'
  }, (payload) => {
    // Process new transcript
    handleTranscriptUpdate(payload.new.transcript_text);
  })
  .subscribe();

const questionsChannel = supabase
  .channel('producer_questions')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'show_questions'
  }, (payload) => {
    // Process Producer AI question
    if (payload.new.source === 'producer_ai') {
      speakProducerQuestion(payload.new);
    }
  })
  .subscribe();
```

---

## 📊 How It Works Now

### Data Flow

```
Stream Audio
    ↓
[Producer AI] (useProducerAI.ts)
    ↓
Analyzes transcripts every 2 minutes
    ↓
Stores in Supabase:
  - betabot_conversation_log (transcripts)
  - show_questions (generated questions)
    ↓
[Supabase Real-time] triggers subscriptions
    ↓
[BetaBot] (useBetaBotComplete.ts)
    ↓
├─ New transcript → Check for "Hey BetaBot" keyword
└─ New question → Speak immediately (TTS)
```

---

## 🎬 Two Input Modes

### Mode 1: Keyword Activation (User says on stream)

```
User: "Hey BetaBot Alakazam when did World War 2 start?"
    ↓
Transcript stored in betabot_conversation_log
    ↓
BetaBot receives via Supabase subscription
    ↓
detectKeywords() → Wake word ✅ + Alakazam ✅
    ↓
Searches Perplexity
    ↓
Speaks result + displays on stream
```

### Mode 2: Producer AI Questions (Automatically generated)

```
Producer AI analyzes conversation
    ↓
Generates question: "That's fascinating! How did you..."
    ↓
Stores in show_questions table (source: 'producer_ai')
    ↓
BetaBot receives via Supabase subscription
    ↓
Speaks immediately (TTS)
    ↓
Displays as super chat
```

---

## 🗄️ Database Tables Used

### `betabot_conversation_log`
Stores all transcripts from the stream.

**Columns BetaBot uses:**
- `id` - Unique identifier (for deduplication)
- `transcript_text` - The actual transcript
- `created_at` - Timestamp
- `speaker_type` - Who spoke (host, guest, etc.)

**BetaBot listens for:** `INSERT` events

### `show_questions`
Stores questions generated by Producer AI.

**Columns BetaBot uses:**
- `id` - Unique identifier (for deduplication)
- `question_text` - The question to speak
- `source` - Where it came from ('producer_ai', 'manual', etc.)
- `ai_generated` - Boolean flag
- `context_summary` - Mode/context info
- `created_at` - Timestamp

**BetaBot listens for:** `INSERT` events where `source = 'producer_ai'`

---

## 🎯 Subscription Logic

### Transcript Subscription
```typescript
// Subscribe to new transcripts
const transcriptChannel = supabase
  .channel('betabot_transcripts')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'betabot_conversation_log'
  }, (payload) => {
    const newTranscript = payload.new;

    // Avoid duplicate processing
    if (lastTranscriptIdRef.current === newTranscript.id) return;
    lastTranscriptIdRef.current = newTranscript.id;

    // Update live transcript
    setLiveTranscript(newTranscript.transcript_text);

    // Check for keywords
    handleTranscriptUpdate(newTranscript.transcript_text);
  })
  .subscribe();
```

### Producer AI Question Subscription
```typescript
// Subscribe to Producer AI questions
const questionsChannel = supabase
  .channel('producer_questions')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'show_questions'
  }, (payload) => {
    const newQuestion = payload.new;

    // Avoid duplicate processing
    if (lastQuestionIdRef.current === newQuestion.id) return;
    lastQuestionIdRef.current = newQuestion.id;

    // Only process Producer AI questions
    if (newQuestion.source === 'producer_ai' || newQuestion.ai_generated) {
      speakProducerQuestion({
        question: newQuestion.question_text,
        mode: newQuestion.context_summary || 'creative',
        context: newQuestion
      });
    }
  })
  .subscribe();
```

---

## 🚀 Benefits

### ✅ No Backend Changes Needed
- Producer AI already works with Supabase
- No WebSocket server to set up
- No new infrastructure

### ✅ Real-time Performance
- Supabase real-time is fast (~100-200ms latency)
- Comparable to WebSocket performance
- Built-in reconnection handling

### ✅ Reliability
- Automatic reconnection
- Message deduplication (via ID tracking)
- No message loss (database-backed)

### ✅ Scalability
- Supabase handles connection pooling
- Can support multiple BetaBot instances
- Database persistence for debugging

---

## 🔍 Deduplication Strategy

BetaBot tracks the last processed IDs to avoid duplicate processing:

```typescript
const lastTranscriptIdRef = useRef<string | null>(null);
const lastQuestionIdRef = useRef<string | null>(null);

// In subscription handler:
if (lastTranscriptIdRef.current === newTranscript.id) {
  return; // Already processed
}
lastTranscriptIdRef.current = newTranscript.id;
```

**Why this matters:**
- Supabase subscriptions can sometimes fire multiple times
- Prevents BetaBot from processing same transcript twice
- Prevents speaking the same question multiple times

---

## 📝 Environment Variables

No new environment variables needed! BetaBot uses existing Supabase config:

```bash
# Already in your .env.local
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key

# Search API keys (if you have them)
VITE_PERPLEXITY_API_KEY=your-perplexity-key
VITE_YOUTUBE_API_KEY=your-youtube-key
VITE_UNSPLASH_ACCESS_KEY=your-unsplash-key
```

---

## 🧪 Testing the Integration

### Test 1: Keyword Activation

**Steps:**
1. Add a transcript to `betabot_conversation_log`:
```sql
INSERT INTO betabot_conversation_log (transcript_text, speaker_type)
VALUES ('Hey BetaBot Alakazam when did World War 2 start', 'user');
```

2. Watch console:
```
📨 New transcript: Hey BetaBot Alakazam when did World War 2 start
👋 Wake word detected!
🎯 Action: alakazam
💬 Query: "when did World War 2 start"
🔍 Alakazam! Searching Perplexity...
🔊 Speaking: [Perplexity result]
```

3. ✅ Expected: BetaBot searches Perplexity and speaks result

---

### Test 2: Producer AI Question

**Steps:**
1. Let Producer AI generate a question (or insert manually):
```sql
INSERT INTO show_questions (
  question_text,
  source,
  ai_generated,
  context_summary
)
VALUES (
  'That's fascinating! Can you tell us more?',
  'producer_ai',
  true,
  'creative'
);
```

2. Watch console:
```
📨 Producer AI question: That's fascinating! Can you tell us more?
🔊 Speaking now...
✅ Finished speaking
```

3. ✅ Expected: BetaBot speaks the question immediately

---

### Test 3: Normal Conversation (No Wake Word)

**Steps:**
1. Add transcript WITHOUT wake word:
```sql
INSERT INTO betabot_conversation_log (transcript_text, speaker_type)
VALUES ('I think that's a really interesting point', 'user');
```

2. Watch console:
```
📨 New transcript: I think that's a really interesting point
```

3. ✅ Expected: BetaBot does NOTHING (no wake word detected)

---

## 🛠️ Troubleshooting

### BetaBot not receiving transcripts

**Check:**
1. Supabase real-time is enabled for the table
2. Console shows: `✅ Subscribed to transcripts`
3. RLS policies allow reading `betabot_conversation_log`

**Fix:**
```sql
-- Enable real-time
ALTER PUBLICATION supabase_realtime ADD TABLE betabot_conversation_log;

-- Check RLS policy
SELECT * FROM pg_policies WHERE tablename = 'betabot_conversation_log';
```

---

### BetaBot not receiving Producer AI questions

**Check:**
1. Supabase real-time is enabled for the table
2. Console shows: `✅ Subscribed to Producer AI questions`
3. Questions have `source = 'producer_ai'` or `ai_generated = true`

**Fix:**
```sql
-- Enable real-time
ALTER PUBLICATION supabase_realtime ADD TABLE show_questions;

-- Verify question source
SELECT id, question_text, source, ai_generated
FROM show_questions
ORDER BY created_at DESC
LIMIT 5;
```

---

### Duplicate processing

**Check:**
- Console logs show same transcript ID multiple times
- Same question being spoken twice

**Fix:**
- Already handled via `lastTranscriptIdRef` and `lastQuestionIdRef`
- If still happening, check for multiple `useBetaBotComplete` instances

---

## 📊 Performance Comparison

### Supabase Real-time vs WebSocket

| Metric | Supabase | WebSocket |
|--------|----------|-----------|
| **Latency** | 100-200ms | 50-100ms |
| **Setup** | ✅ None (built-in) | ⚠️ Server required |
| **Reconnection** | ✅ Automatic | ⚠️ Manual |
| **Message Loss** | ✅ None (DB-backed) | ⚠️ Possible |
| **Debugging** | ✅ Easy (check DB) | ⚠️ Harder |
| **Scalability** | ✅ Excellent | ⚠️ Manual |

**Verdict:** Supabase real-time is the right choice for this use case.

---

## 🎯 Integration Complete

### ✅ What Works Now

1. **Keyword Activation**
   - User says "Hey BetaBot Alakazam ..."
   - Transcript stored in DB → BetaBot receives → Searches → Speaks

2. **Producer AI Questions**
   - Producer AI generates question
   - Stored in DB → BetaBot receives → Speaks immediately

3. **No Accidental Searches**
   - Multi-model fusion fixed (Perplexity removed)
   - Only searches with explicit keywords

4. **Fast Responses**
   - BetaBot receives transcripts in real-time
   - ~100-200ms latency for subscriptions

---

## 📚 Files Modified

1. **`src/hooks/useBetaBotComplete.ts`**
   - Replaced WebSocket with Supabase subscriptions
   - Added import for `supabase`
   - Added deduplication refs (`lastTranscriptIdRef`, `lastQuestionIdRef`)

---

## 🚀 Next Steps

1. **Verify API Keys**
   - Check `.env.local` for Perplexity, YouTube, Unsplash keys
   - Producer AI should already have these if you've used search before

2. **Test Keyword Activation**
   - Insert test transcripts with wake word
   - Verify BetaBot detects keywords correctly

3. **Test Producer AI Integration**
   - Let Producer AI run and generate questions
   - Verify BetaBot speaks them automatically

4. **Monitor Performance**
   - Check console logs for subscription status
   - Verify no duplicate processing
   - Monitor response times

---

## 📝 Summary

**What we accomplished:**
- ✅ Integrated BetaBot with existing Producer AI system
- ✅ No backend changes needed (uses Supabase)
- ✅ Real-time transcripts and questions
- ✅ Keyword-based search activation
- ✅ Producer AI question speaking
- ✅ No accidental searches (multi-model fusion fixed)

**Architecture:**
- Producer AI: Analyzes transcripts, generates questions → Supabase
- BetaBot: Subscribes to Supabase → Responds to keywords → Speaks

**Ready to test!** 🎉
